<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>360° VR Experience</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: -apple-system, sans-serif; }
        canvas { display: block; }
        
        /* Interfaccia iniziale */
        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: radial-gradient(circle, #222 0%, #000 100%);
            z-index: 1000; color: white; text-align: center;
        }

        button {
            padding: 18px 40px; font-size: 18px; font-weight: bold;
            background: #ffffff; color: #000; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            transition: transform 0.2s, background 0.2s;
        }

        button:active { transform: scale(0.95); }
        
        #instruction { margin-top: 20px; font-size: 14px; color: #aaa; max-width: 250px; line-height: 1.5; }
    </style>
</head>
<body>

    <div id="ui">
        <h1 style="letter-spacing: 2px;">TOUR 360°</h1>
        <button id="start-btn">AVVIA ESPERIENZA</button>
        <p id="instruction">Su smartphone, muovi il dispositivo per guardarti intorno dopo aver cliccato.</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/DeviceOrientationControls.js"></script>

    <script>
        let camera, scene, renderer, controls, deviceControls;
        let useGiro = false;

        // Inizializzazione della scena
        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1100);
            camera.position.set(0, 0, 0.1);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.outputEncoding = THREE.sRGBEncoding; // Colori corretti
            document.body.appendChild(renderer.domElement);

            // Sfera 360
            const geometry = new THREE.SphereGeometry(500, 60, 40);
            geometry.scale(-1, 1, 1); // Inverti per interno

            const loader = new THREE.TextureLoader();
            // Prova a caricare panorama.jpg, con fallback su immagine di test
            loader.load('panorama.jpg', function(texture) {
                setupScene(texture);
            }, undefined, function() {
                console.warn("panorama.jpg non trovata, carico demo...");
                loader.load('https://threejs.org/examples/textures/2294472375_24a3b8ef46_o.jpg', setupScene);
            });

            // Controlli Mouse/Touch standard (sempre pronti)
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.rotateSpeed = -0.25;
            controls.enablePan = false;

            window.addEventListener('resize', onWindowResize, false);
            animate();
        }

        function setupScene(texture) {
            texture.encoding = THREE.sRGBEncoding;
            const material = new THREE.MeshBasicMaterial({ map: texture });
            const mesh = new THREE.Mesh(new THREE.SphereGeometry(500, 60, 40).scale(-1, 1, 1), material);
            scene.add(mesh);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            
            // Se siamo su mobile e il giroscopio è attivo, usa quello
            if (useGiro && deviceControls) {
                deviceControls.update();
            } else {
                controls.update(); // Altrimenti usa mouse/touch
            }
            
            renderer.render(scene, camera);
        }

        // Gestione dell'avvio tramite interazione utente
        document.getElementById('start-btn').addEventListener('click', function() {
            document.getElementById('ui').style.display = 'none';

            // Attiva Fullscreen
            const el = document.documentElement;
            if (el.requestFullscreen) el.requestFullscreen();
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();

            // Rileva se è un dispositivo mobile
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

            if (isMobile) {
                // Gestione Giroscopio (iOS richiede permesso)
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission().then(response => {
                        if (response === 'granted') {
                            deviceControls = new THREE.DeviceOrientationControls(camera);
                            useGiro = true;
                        }
                    }).catch(e => console.error("Permesso negato"));
                } else {
                    // Android
                    deviceControls = new THREE.DeviceOrientationControls(camera);
                    useGiro = true;
                }
            }
        });

        // Avvio immediato
        init();
    </script>
</body>
</html>